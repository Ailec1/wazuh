<!-- Local rules -->

<!-- Modify it at your will. -->
<!-- Copyright (C) 2015, Wazuh Inc. -->

<!-- Example -->
<group name="local,syslog,sshd,">

  <!--
  Dec 10 01:02:02 host sshd[1234]: Failed none for root from 1.1.1.1 port 1066 ssh2
  -->
  <rule id="100001" level="5">
    <if_sid>5716</if_sid>
    <srcip>1.1.1.1</srcip>
    <description>sshd: authentication failed from IP 1.1.1.1.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

</group>

<!-- <group name="misp,">
  <rule id="100620" level="10">
    <field name="integration">misp</field>
    <match>misp</match>
    <description>MISP Events</description>
    <options>no_full_log</options>
  </rule>
  <rule id="100621" level="5">
    <if_sid>100620</if_sid>
    <field name="misp.error">\.+</field>
    <description>MISP - Error connecting to API</description>
    <options>no_full_log</options>
    <group>misp_error,</group>
  </rule>
  <rule id="100622" level="12">
    <field name="misp.category">\.+</field>
    <description>MISP - IoC found in Threat Intel - Category: $(misp.category), Attribute: $(misp.value)</description>
    <options>no_full_log</options>
    <group>misp_alert,</group>
  </rule>
</group> -->

<!-- VirusTotal -->
<group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
    <!-- Rules for Linux systems -->
    <rule id="100200" level="7">
        <if_sid>550</if_sid>
        <field name="file">/root</field>
        <description>File modified in /root directory.</description>
    </rule>
    <rule id="100201" level="7">
        <if_sid>554</if_sid>
        <field name="file">/root</field>
        <description>File added to /root directory.</description>
    </rule>
</group>

<!-- Yara -->
<group name="syscheck,">
  <rule id="100300" level="7">
    <if_sid>550</if_sid>
    <field name="file">/tmp/yara/malware/</field>
    <description>File modified in /tmp/yara/malware/ directory.</description>
  </rule>
  <rule id="100301" level="7">
    <if_sid>554</if_sid>
    <field name="file">/tmp/yara/malware/</field>
    <description>File added to /tmp/yara/malware/ directory.</description>
  </rule>
</group>

<group name="yara,">
  <rule id="108000" level="0">
    <decoded_as>yara_decoder</decoded_as>
    <description>Yara grouping rule</description>
  </rule>
  <rule id="108001" level="12">
    <if_sid>108000</if_sid>
    <match>wazuh-yara: INFO - Scan result: </match>
    <description>File "$(yara_scanned_file)" is a positive match. Yara rule: $(yara_rule)</description>
  </rule>
</group>

<!-- AbuseIDP -->
<group name="local,syslog,sshd,">
  <rule id="100002" level="5">
    <if_sid>5716</if_sid>
    <match type="pcre2">\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-1])|(25[6-9]|2[6-9][0-9]|[3-9][0-9][0-9]|99[1-9]))[0-9]{1,3}\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</match>
    <description>sshd: Authentication failed from a public IP address $(srcip).</description>
    <group>authentication_failed,authentication_success,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
  <rule id="100003" level="5">
    <if_sid>5715</if_sid>
    <match type="pcre2">\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-1])|(25[6-9]|2[6-9][0-9]|[3-9][0-9][0-9]|99[1-9]))[0-9]{1,3}\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</match>
    <description>sshd: Authentication succeeded from a public IP address $(srcip).</description>
    <group>authentication_failed,authentication_success,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
    <rule id="100004" level="10">
    <field name="abuseipdb.source.rule" type="pcre2">^100002$</field>
    <field name="abuseipdb.abuse_confidence_score" type="pcre2" negate="yes">^0$</field>
    <description>AbuseIPDB: SSH Authentication failed from a public IP address $(srcip) with $(abuseipdb.abuse_confidence_score)% confidence of abuse.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
  <rule id="100005" level="14">
    <field name="abuseipdb.source.rule" type="pcre2">^100003$</field>
    <field name="abuseipdb.abuse_confidence_score" type="pcre2" negate="yes">^0$</field>
    <description>AbuseIPDB: SSH Authentication succeeded from a public IP address $(srcip) with $(abuseipdb.abuse_confidence_score)% confidence of abuse.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
</group>
<group name="threat_intel,">
<rule id="100651" level="12">
    <field name="abuseipdb.abuse_confidence_score" type="pcre2" negate="yes">^0$</field>
    <description>IP with $(abuseipdb.abuse_confidence_score)% confidence of abuse was connected to.</description>
    <group>abuseipdb,abuseipdb_alert,</group>
  </rule>
</group>

<var name="MS_FREQ">8</var>
<group name="windows,">
  <!-- Powershell -->
  <rule id="100535" level="1">
    <if_sid>60009</if_sid>
    <field name="win.system.providerName">^PowerShell$</field>
    <mitre>
      <id>T1086</id>
    </mitre>
    <options>no_full_log</options>
    <group>windows_powershell,</group>
    <description>Powershell Information EventLog</description>
  </rule>
  <rule id="100536" level="5">
    <if_sid>60010</if_sid>
    <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
    <field name="win.system.severityValue">^WARNING$</field>
    <mitre>
      <id>T1086</id>
    </mitre>
    <options>no_full_log</options>
    <group>windows_powershell,</group>
    <description>Powershell Warning EventLog</description>
  </rule>
  <rule id="100537" level="7">
    <if_sid>60011</if_sid>
    <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
    <mitre>
      <id>T1086</id>
    </mitre>
    <options>no_full_log</options>
    <group>windows_powershell,</group>
    <description>Powershell Error EventLog</description>
  </rule>
  <rule id="100538" level="12">
    <if_sid>60012</if_sid>
    <field name="win.system.providerName">^Microsoft-Windows-PowerShell$</field>
    <mitre>
      <id>T1086</id>
    </mitre>
    <options>no_full_log</options>
    <group>windows_powershell,</group>
    <description>Powershell Critical EventLog</description>
  </rule>
  <rule id="100539" level="12" frequency="$MS_FREQ" timeframe="60">
      <if_matched_sid>100537</if_matched_sid>
      <description>Short-time multiple Windows Powershell error events</description>
      <mitre>
        <id>T1086</id>
      </mitre>
      <options>no_full_log</options>
      <group>pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  <rule id="100540" level="14" frequency="$MS_FREQ" timeframe="60">
      <if_matched_sid>100538</if_matched_sid>
      <description>Short-time multiple Windows Powershell critical events</description>
      <mitre>
        <id>T1086</id>
      </mitre>
      <options>no_full_log</options>
      <group>pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  <rule id="100541" level="3">
    <if_sid>91802</if_sid>
    <field name="win.system.severityValue">VERBOSE</field>
    <description>Powershell script $(win.eventdata.scriptBlockText) Executed</description>
    <mitre>
      <id>T1087.002</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
  <rule id="100542" level="1">
    <if_sid>100541</if_sid>
    <field name="win.system.eventID">^4105$|^4106$</field>
    <description>Disregard Powershell Text</description>
    <mitre>
      <id>T1087.002</id>
    </mitre>
  </rule>
  <rule id="100544" level="1">
    <if_sid>100541</if_sid>
    <field name="win.eventdata.scriptBlockText">PSMessageDetails|ErrorCategory_Message|OriginInfo</field>
    <description>Disregard Powershell Prompt Text</description>
    <mitre>
      <id>T1087.002</id>
    </mitre>
  </rule>
  <rule id="100545" level="1">
    <if_sid>100541</if_sid>
    <field name="win.eventdata.scriptBlockText">^prompt$</field>
    <description>Disregard Powershell Prompt Text</description>
    <mitre>
      <id>T1087.002</id>
    </mitre>
  </rule>
  <rule id="100550" level="3">
    <if_sid>100535</if_sid>
    <field name="win.system.eventID">^400$</field>
    <mitre>
      <id>T1086</id>
    </mitre>
    <options>no_full_log</options>
    <group>windows_powershell,</group>
    <description>Powershell Information EventLog</description>
  </rule>
</group>


<!-- Rule exclusion -->
<group name="rule_exclusion,">
<!-- Logon/Logoff Machine Accounts -->
  <rule id="900001" level="1">
    <if_sid>60106</if_sid>
    <field name="win.eventdata.targetUserName">\$$</field>
    <description>Exclude Computer Account logons</description>
    <options>no_full_log</options>
  </rule>
  <rule id="900002" level="1">
    <if_sid>60137</if_sid>
    <field name="win.eventdata.targetUserName">\$$</field>
    <description>Exclude Computer Account logouts</description>
    <options>no_full_log</options>
  </rule>
<!-- Logon FREQ Rule -->
  <rule id="900003" level="1" frequency="2" timeframe="5">
   <if_matched_sid>60106</if_matched_sid>
   <same_field>win.eventdata.targetUserName</same_field>
   <description>Exclude same username login twice in 1 minute</description>
  </rule>
<!-- Exclude Audit Failure Events SeTcbPrivilege -->
  <rule id="900004" level="1">
    <if_sid>60107</if_sid>
    <field name="win.eventdata.privilegeList">^SeTcbPrivilege$</field>
    <description>Exclude Audit Failure Events SeTcbPrivilege</description>
    <options>no_full_log</options>
  </rule>
  <!-- Exclude Ossec Process -->
  <rule id="900005" level="1">
    <if_group>osquery</if_group>
    <field name="columns.cwd">^/var/ossec$</field>
    <description>Exclude ossec</description>
    <options>no_full_log</options>
  </rule>
</group>